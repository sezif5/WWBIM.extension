# Ежедневный экспорт NWC

Скрипт для ежедневного экспорта моделей Revit в формат Navisworks (.nwc) с автоматической проверкой актуальности и запуском по расписанию через Windows Scheduled Task.

## Описание

Скрипт автоматизирует процесс ежедневного экспорта множества RVT-файлов в формат NWC для использования в Navisworks. Основная цель - получать актуальные NWC файлы каждый день автоматически, экспортируя только изменившиеся модели.

## Основные возможности

- **Ежедневный экспорт**: автоматический запуск в указанное время (по умолчанию 00:00)
- **Проверка актуальности**: сравнение дат изменения RVT и NWC файлов
- **Умный экспорт**: экспортируются только изменившиеся модели
- **Гибкая конфигурация**: настройка через txt файлы в папке Object
- **Логирование**: детальные логи в отдельные файлы по дням (хранение 7 дней)
- **Защита от повторного запуска**: lock-файл для предотвращения конфликта

## Зависимости

### Внутренние модули (lib/)
- `nwc_export_utils.py` - модуль экспорта NWC
- `openbg.py` - модуль фонового открытия RVT-файлов
- `closebg.py` - модуль безопасного закрытия документов

### Revit API
- `Autodesk.Revit.DB`: ModelPathUtils, View3D, NavisworksExportOptions, FilteredElementCollector

### pyRevit
- `script`, `coreutils`, `forms` - для UI, таймеров и диалогов
- `forms.SelectFromList` - выбор объектов
- `forms.pick_folder` - выбор папки
- `forms.ask_for_string` - настройка времени

## Архитектура

### Логика работы

```
1. Первичная настройка (ручной режим):
   - Выбор папки Object (сохраняется в Object_folder_path.txt)
   - Выбор объектов для экспорта (сохраняется в Ежедневная выгрузка.txt)
   - Настройка времени автозапуска (создаётся scheduled task)

2. Повторный запуск (ручной режим):
   - Читаются сохранённые настройки
   - Главное меню с опциями:
     * Экспортировать сейчас
     * Настроить список объектов
     * Настроить папку Object
     * Настроить автозапуск
     * Удалить автозапуск

3. Автоматический запуск (scheduled task):
   - Запуск скрипта с флагом --auto
   - Читаются сохранённые настройки
   - Проверка актуальности и экспорт
   - Логирование в файл
   - Завершение без UI
```

### Проверка актуальности

```python
def check_need_export(rvt_path, nwc_folder, object_name):
    # Если NWC не существует → нужно экспортировать
    if not os.path.exists(nwc_path):
        return True, "NWC не существует"

    # Сравниваем даты изменения
    rvt_mtime = os.path.getmtime(rvt_path)
    nwc_mtime = os.path.getmtime(nwc_path)

    if rvt_mtime > nwc_mtime:
        return True, "RVT обновлён"

    return False, "NWC актуален"
```

### Scheduled Task

Скрипт создаёт Windows Scheduled Task для ежедневного запуска:

1. Создаётся bat-файл `run_daily_export.bat`:
```batch
@echo off
echo Starting daily NWC export at %date% %time%
C:\Users\Vladi\AppData\Roaming\pyRevit\Revit\addin\bin\pyrevit.exe run "WW.BIM.tab BIM.panel Экспорт.stack Ежедневный экспорт NWC.pushbutton" --auto --time 00:00
echo Export completed at %date% %time%
```

2. Создаётся scheduled task через `schtasks.exe`:
```batch
schtasks /create /tn "Ежедневный экспорт NWC" /tr "D:\Project\Object\run_daily_export.bat" /sc daily /st 00:00 /f
```

## Конфигурация

### Файловая структура данных (в проекте):

```
Проект/Object/
├── Здание1.txt                      # C:/Project/Здание1.rvt
├── Здание1_NWC.txt                  # D:/NWC/Здание1/
├── Здание2.txt                      # C:/Project/Здание2.rvt
├── Здание2_NWC.txt                  # D:/NWC/Здание2/
├── Здание3.txt                      # C:/Project/Здание3.rvt
├── Здание3_NWC.txt                  # D:/NWC/Здание3/
├── Ежедневная выгрузка.txt          # Здание1,Здание2 (список)
├── Object_folder_path.txt            # D:/Project/Object/ (путь к папке)
├── run_daily_export.bat             # bat-файл для автозапуска
├── logs/                            # папка для логов
│   └── export_log_2025-01-19.txt  # лог за день
└── .export_lock                     # lock-файл для защиты от повторного запуска
```

### Формат файлов конфигурации

#### `Объект.txt`:
```
C:/Project/Здание1.rvt
```

#### `Объект_NWC.txt`:
```
D:/NWC/Экспорт/Здание1/
```

#### `Ежедневная выгрузка.txt`:
```
Здание1
Здание2
Здание3
```

#### `Object_folder_path.txt`:
```
D:/Project/Object/
```

### Константы скрипта

- `OBJECT_FOLDER_CONFIG` = "Object_folder_path.txt"
- `DAILY_EXPORT_LIST` = "Ежедневная выгрузка.txt"
- `LOG_FOLDER` = "logs"
- `AUTO_MODE_FLAG` = "--auto"
- `LOCK_FILE` = ".export_lock"
- `TASK_NAME` = "Ежедневный экспорт NWC"
- `BAT_FILE` = "run_daily_export.bat"
- `LOG_RETENTION_DAYS` = 7

## Оптимизации производительности

### 1. Проверка актуальности
- **Проблема**: экспортировать все модели каждый день → медленно
- **Решение**: сравнение дат RVT и NWC → экспорт только изменившихся

### 2. Фильтрация рабочих наборов
- Используется предикат из `openbg.py`
- Исключаются рабочие наборы: начинающиеся с `00_`, содержащие 'Link' или 'Связь'

### 3. Detached-режим
- Опция: `detach=True` → `DetachAndPreserveWorksets`
- Эффект: нет синхронизации с центральной моделью, быстрее открытие/закрытие

### 4. Автоматическое подавление предупреждений
- Используется `openbg.open_in_background()` с `suppress_dialogs=True`
- Автоматически закрываются диалоговые окна Revit

## Вывод информации

### Логирование в файл

Формат лог файла `export_log_YYYY-MM-DD.txt`:

```
========================================
Ежедневный экспорт NWC - 2025-01-19 00:00:00
========================================

[00:00:01] Объект: Здание1
[00:00:01]   - RVT: C:/Project/Здание1.rvt
[00:00:01]   - NWC: D:/NWC/Здание1/Здание1.nwc
[00:00:01]   - Причина: RVT обновлён
[00:00:05]   - Экспорт: УСПЕХ (время: 4s, размер: 45.2 MB)

[00:00:05] Объект: Здание2
[00:00:05]   - RVT: C:/Project/Здание2.rvt
[00:00:05]   - NWC: D:/NWC/Здание2/Здание2.nwc
[00:00:05]   - Причина: NWC актуален
[00:00:05]   - RVT дата: 2025-01-17 10:00:00
[00:00:05]   - NWC дата: 2025-01-18 00:00:01

[00:00:05] Объект: Здание3
[00:00:05]   - Ошибка: Файл RVT не найден

========================================
ИТОГО: Всего: 3, Экспортировано: 1, Пропущено: 1, Ошибок: 1
Время выполнения: 6s
========================================
```

### Вывод в PyRevit Output (ручной режим):

```
## ЭКСПОРТ NWC (2)
Папка экспорта: **D:/Project/Object**
___

:hourglass: Экспортирую: **Здание1**
:white_check_mark: Здание1: УСПЕХ (45.2 MB)

:hourglass: Экспортирую: **Здание2**
:white_check_mark: Здание2: NWC актуален

___
**Готово. Всего: 2, Экспортировано: 1, Пропущено: 1, Ошибок: 0**
**Время выполнения: 5s**
**Лог: `D:/Project/Object/logs/export_log_2025-01-19.txt`**
```

## Технические детали

### Защита от повторного запуска

Используется lock-файл `.export_lock` в папке Object:

1. При запуске скрипт проверяет наличие lock-файла
2. Если lock-файл существует:
   - Проверяем его возраст (если старше 24 часов → удаляем)
   - Если новый → выходим с сообщением "Скрипт уже выполняется"
3. При успешном запуске создаётся lock-файл с текущим временем
4. При завершении скрипта lock-файл удаляется

### Хранение логов

Логи хранятся в папке `logs` внутри папки Object:

- Название файла: `export_log_YYYY-MM-DD.txt`
- Хранение: 7 дней (старые логи удаляются автоматически)
- Режим записи: append (добавление в конец файла)

### Настройка времени экспорта

Для тестирования можно настроить любое время экспорта:

1. Ручной режим → "Настроить автозапуск"
2. Ввести время в формате ЧЧ:ММ (например, 14:30)
3. Scheduled task пересоздаётся на указанное время

## Совместимость

- **Revit**: 2020-2024
- **pyRevit**: требуется установленный pyRevit с поддержкой Revit API
- **Windows**: 7+ (для работы scheduled tasks)

## Пример использования

### Первичная настройка:

1. Запустить скрипт в ручном режиме
2. Выбрать папку `Object`
3. Создать файлы конфигурации:
   - `Здание1.txt` → путь к RVT
   - `Здание1_NWC.txt` → папка для NWC
4. Выбрать объекты для ежедневной выгрузки
5. Настроить автозапуск на 00:00
6. Готово!

### Повторный запуск:

1. Нажать кнопку "Ежедневный экспорт NWC"
2. Выбрать опцию "Экспортировать сейчас"
3. Скрипт проверит актуальность и экспортирует изменившиеся модели

### Автоматический запуск:

1. Scheduled task запускает bat-файл в 00:00
2. Скрипт запускается с флагом `--auto`
3. Проверяется актуальность и выполняется экспорт
4. Результаты записываются в лог файл

## Возможные улучшения

- [ ] Добавить поддержку экспорта в форматы NWD/NWF
- [ ] Добавить настройку списка скрываемых категорий через UI
- [ ] Поддержка экспорта по уровням/зонам
- [ ] Параллельный экспорт (если Revit API позволит)
- [ ] Экспорт сводки об ошибках в CSV/Excel
- [ ] Отправка уведомлений по email/Telegram при ошибках

## Устранение проблем

### Проблема: "Не настроена папка Object"
**Решение**: Запустите скрипт в ручном режиме и выберите папку Object через диалог

### Проблема: "Не настроен список объектов"
**Решение**: Создайте файлы `ИмяОбъекта.txt` и `ИмяОбъекта_NWC.txt` в папке Object, затем выберите объекты через UI

### Проблема: "Не найден pyrevit.exe"
**Решение**: Проверьте установку pyRevit. Стандартные пути:
- `C:\Users\<User>\AppData\Roaming\pyRevit\Revit\addin\bin\pyrevit.exe`
- `C:\Users\<User>\AppData\Local\pyRevit\bin\pyrevit.exe`

### Проблема: "Скрипт уже выполняется"
**Решение**: Если скрипт завис, удалите файл `.export_lock` в папке Object вручную

### Проблема: "Ошибка открытия: файл не найден"
**Решение**: Проверьте правильность путей в файлах `ИмяОбъекта.txt`

## Реализованные возможности

- [x] Ежедневный экспорт NWC с проверкой актуальности
- [x] Автоматический запуск через Windows Scheduled Task
- [x] Гибкая конфигурация через txt файлы
- [x] Детальное логирование в отдельные файлы
- [x] Защита от повторного запуска
- [x] Автоматическое удаление старых логов (7 дней)
- [x] Настройка времени экспорта для тестирования
- [x] Обработка ошибок с продолжением выполнения
- [x] Использование обработки ошибок из openbg.py
